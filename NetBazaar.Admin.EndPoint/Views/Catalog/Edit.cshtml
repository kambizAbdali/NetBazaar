@model NetBazaar.Admin.EndPoint.ViewModels.Catalog.AddCatalogItemViewModel
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "ویرایش محصول";
}

<h2>ویرایش محصول</h2>

<form asp-action="Edit" method="post">
    <input type="hidden" asp-for="Id" />
    <div asp-validation-summary="All" class="text-danger"></div>

    <div class="mb-3">
        <label>نام محصول</label>
        <input asp-for="Name" class="form-control" />
        <span asp-validation-for="Name" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label>توضیحات</label>
        <textarea asp-for="Description" class="form-control" id="Description"></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label>قیمت (ریال)</label>
        <input asp-for="Price" class="form-control numeric-input" />
        <span asp-validation-for="Price" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label>دسته‌بندی</label>
        <select asp-for="CatalogTypeId" asp-items="Model.Types" class="form-select" id="CatalogTypeId"></select>
        <span asp-validation-for="CatalogTypeId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label>برند</label>
        <select asp-for="CatalogBrandId" asp-items="Model.Brands" class="form-select"></select>
        <span asp-validation-for="CatalogBrandId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label>موجودی انبار</label>
        <input asp-for="StockQuantity" class="form-control numeric-input" />
        <span asp-validation-for="StockQuantity" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label>حداقل موجودی برای هشدار</label>
        <input asp-for="ReorderThreshold" class="form-control numeric-input" />
        <span asp-validation-for="ReorderThreshold" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label>حداکثر ظرفیت انبار</label>
        <input asp-for="MaxStockThreshold" class="form-control numeric-input" />
        <span asp-validation-for="MaxStockThreshold" class="text-danger"></span>
    </div>

    <!-- بخش ویژگی‌ها -->
    <h5>ویژگی‌ها</h5>
    <div id="featuresContainer">
        @for (int i = 0; i < Model.Features.Count; i++)
        {
            <div class="row mb-2">
                <div class="col"><input name="Features[@i].Group" value="@Model.Features[i].Group" class="form-control" required /></div>
                <div class="col"><input name="Features[@i].Key" value="@Model.Features[i].Key" class="form-control" required /></div>
                <div class="col"><input name="Features[@i].Value" value="@Model.Features[i].Value" class="form-control" required /></div>
                <div class="col"><button type="button" class="btn btn-danger delete-feature">حذف</button></div>
            </div>
        }
    </div>

    <!-- فیلدهای ورودی برای افزودن ویژگی جدید -->
    <div class="row mb-3">
        <div class="col">
            <input id="featureGroup" class="form-control" placeholder="گروه" />
        </div>
        <div class="col">
            <input id="featureKey" class="form-control" placeholder="کلید" />
        </div>
        <div class="col">
            <input id="featureValue" class="form-control" placeholder="مقدار" />
        </div>
        <div class="col">
            <button type="button" class="btn btn-info" onclick="addFeature()">افزودن ویژگی</button>
        </div>
    </div>

    <!-- بخش تصاویر -->
    <h5>تصاویر</h5>
    <div id="imagesContainer">
        @for (int i = 0; i < Model.Images.Count; i++)
        {
            <div class="row mb-2">
                <div class="col-10">
                    <input type="text" name="Images[@i].Src" value="@Model.Images[i].Src" class="form-control" readonly />
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-danger delete-image">حذف</button>
                </div>
            </div>
        }
    </div>
    <button type="button" class="btn btn-info mb-3" onclick="addImage()">افزودن تصویر</button>

    <button type="submit" class="btn btn-primary">ذخیره تغییرات</button>
    <a asp-action="Index" class="btn btn-secondary">بازگشت</a>
</form>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let featureIndex = @Model.Features.Count;
        let imageIndex = @Model.Images.Count;

        function addFeature() {
            const group = $('#featureGroup').val();
            const key = $('#featureKey').val();
            const value = $('#featureValue').val();

            if (!group || !key || !value) {
                if (!group) $('#featureGroup').addClass('is-invalid'); else $('#featureGroup').removeClass('is-invalid').addClass('is-valid');
                if (!key) $('#featureKey').addClass('is-invalid'); else $('#featureKey').removeClass('is-invalid').addClass('is-valid');
                if (!value) $('#featureValue').addClass('is-invalid'); else $('#featureValue').removeClass('is-invalid').addClass('is-valid');
                return;
            }

            $('#featuresContainer').append(`
                <div class="row mb-2">
                    <div class="col"><input name="Features[${featureIndex}].Group" value="${group}" class="form-control" required /></div>
                    <div class="col"><input name="Features[${featureIndex}].Key" value="${key}" class="form-control" required /></div>
                    <div class="col"><input name="Features[${featureIndex}].Value" value="${value}" class="form-control" required /></div>
                    <div class="col"><button type="button" class="btn btn-danger delete-feature">حذف</button></div>
                </div>
            `);

            featureIndex++;
            $('#featureGroup').val('').removeClass('is-valid is-invalid');
            $('#featureKey').val('').removeClass('is-valid is-invalid');
            $('#featureValue').val('').removeClass('is-valid is-invalid');
        }

        $(document).on('click', '.delete-feature', function () {
            $(this).closest('.row').remove();
        });

        function addImage() {
            $('#imagesContainer').append(`
                <div class="row mb-2">
                    <div class="col-10">
                        <input type="file" class="form-control image-upload" onchange="uploadImage(this, ${imageIndex})" required />
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-danger delete-image">حذف</button>
                    </div>
                </div>
            `);
            imageIndex++;
        }

        $(document).on('click', '.delete-image', function () {
            $(this).closest('.row').remove();
        });

        function uploadImage(input, index) {
            if (!input.files || input.files.length === 0) {
                $(input).addClass('is-invalid');
                return;
            } else {
                $(input).removeClass('is-invalid').addClass('is-valid');
            }

            var formData = new FormData();
            formData.append("file", input.files[0]);

            $.ajax({
                url: "http://localhost:5072/api/images/upload",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    $(input).after(`<input type="hidden" name="Images[${index}].Src" value="${response.url}" />`);
                },
                error: function () {
                    alert("خطا در آپلود تصویر");
                }
            });
        }
    </script>

    <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
    <script>
        CKEDITOR.replace('Description', {
            language: 'fa',
            contentsLangDirection: 'rtl',
            removePlugins: 'elementspath',
            resize_enabled: false
        });
    </script>

    <style>
        .numeric-input {
            direction: rtl;
            text-align: right;

            <style > .numeric-input {
                direction: rtl; /* راست‌چین */
                text-align: right; /* متن راست‌چین */
                font-family: Tahoma, "IRANSans", "Vazir", sans-serif; /* فونت فارسی */
            }
        }
    </style>


    <script>
        // فعال‌سازی CKEditor روی فیلد توضیحات
        CKEDITOR.replace('Description', {
            language: 'fa', // زبان فارسی
            contentsLangDirection: 'rtl', // راست‌چین
            removePlugins: 'elementspath',
            resize_enabled: false
        });
    </script>

     @* فعالسازی نمایش ساختار درختی روی دسته بندی محصولات *@
    <script src="~/js/select2/select2.min.js"></script>
    <link href="~/css/select2/select2.min.css" rel="stylesheet" />
    <script>
        $(document).ready(function () {
            $('#CatalogTypeId').select2({
                dir: "rtl",
                placeholder: "انتخاب دسته‌بندی...",
                language: "fa"
            });
        });
    </script>
}