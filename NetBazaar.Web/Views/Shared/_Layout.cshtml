@{
    Layout = null;
    var title = ViewData["Title"] as string ?? "نت بازار";
}

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@title</title>
    <meta name="description" content="فروشگاه مدرن نت بازار" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <script src="~/js/basket-update.js" asp-append-version="true"></script>


    <link href="~/css/vazirmatn-font-face.css" rel="stylesheet" />
    <link href="~/lib/bootstrap/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
    <link href="~/css/site.css" rel="stylesheet" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/moment.min.js"></script>
    <script src="~/js/site.js"></script>
    <script src="~/js/ajax.js"></script>

    <script src="~/js/signalr/dist/browser/signalr.min.js"></script>
    <script>
        // اتصال به هاب وب
        const webConnection = new signalR.HubConnectionBuilder()
            .withUrl("/Hubs/OnlineVisitorsHub", { withCredentials: true })
            .withAutomaticReconnect()
            .build();

        webConnection.on("OnlineCountUpdated", function(count) {
            // اگر در وب هم می‌خواهی نشان دهی، جایگزین کن
            const el = document.getElementById("online-count-web");
            if (el) el.textContent = count.toString();
        });

        webConnection.start().catch(err => console.error(err));
    </script>
    <script src="~/js/category-menu.js"></script>


</head>
<body class="bg-light">
    @Html.AntiForgeryToken()
    <header>
        @await Html.PartialAsync("_Navbar")
        @await Html.PartialAsync("_DiscountBanner")
    </header>

    <main class="container py-3">
        <div class="row">
            @if (TempData["HideMenuCategories"] as bool? != true)
            {
                <aside class="col-12 col-lg-3 mb-3">
                    @await Component.InvokeAsync("GetMenuCategories")
                    @await Html.PartialAsync("_MiniCart")
                </aside>
            }
            <section class="col-12 col-lg-9">
                @RenderBody()
            </section>
        </div>
    </main>

    <footer class="mt-4">
        @await Html.PartialAsync("_Footer")
    </footer>

    @RenderSection("Scripts", required: false)
</body>

@await Html.PartialAsync("_OperationResultModal")
@await Html.PartialAsync("_Notification")
</html>

<script>
    // تابع global برای به‌روزرسانی سبد خرید
    window.updateBasket = function(itemsCount) {
        const basketBadge = document.querySelector('#basketDropdown .badge');
        const basketCountElements = document.querySelectorAll('.basket-count, .cart-count');

        if (itemsCount > 0) {
            if (basketBadge) {
                basketBadge.textContent = itemsCount;
                basketBadge.style.display = 'inline';
            }
            basketCountElements.forEach(el => {
                el.textContent = itemsCount;
                el.style.display = 'inline';
            });
        } else {
            if (basketBadge) {
                basketBadge.style.display = 'none';
            }
            basketCountElements.forEach(el => {
                el.style.display = 'none';
            });
        }
    };
</script>